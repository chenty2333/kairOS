name: ci-quick

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-quick-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-gates:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: riscv64
            boot_smp: 1
            gate_timeout: 300
          - arch: x86_64
            boot_smp: 2
            gate_timeout: 300
          - arch: aarch64
            boot_smp: 2
            gate_timeout: 360

    env:
      ARCH: ${{ matrix.arch }}
      BOOT_SMP: ${{ matrix.boot_smp }}
      GATE_TIMEOUT: ${{ matrix.gate_timeout }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install host dependencies
        run: |
          set -euo pipefail
          scripts/impl/ci-bootstrap.sh install-host-deps "${ARCH}"

      - name: Restore third-party source cache
        uses: actions/cache@v4
        with:
          path: third_party
          key: third-party-${{ runner.os }}-${{ hashFiles('scripts/impl/fetch-deps.sh') }}
          restore-keys: |
            third-party-${{ runner.os }}-

      - name: Fetch required third-party sources
        run: |
          set -euo pipefail
          scripts/impl/ci-bootstrap.sh fetch-required-third-party

      - name: Locate UEFI firmware
        run: |
          set -euo pipefail
          scripts/impl/ci-bootstrap.sh locate-uefi "${ARCH}"

      - name: Run quick gate stack
        run: |
          set -euo pipefail

          latest_run() {
            ls -1dt build/runs/* 2>/dev/null | head -n 1 || true
          }

          assert_structured_latest() {
            label="$1"
            latest="$(latest_run)"
            if [[ -z "${latest}" ]]; then
              echo "No isolated run found after ${label}" >&2
              exit 2
            fi
            python3 scripts/impl/assert-result-pass.py "${latest}/result.json" --require-structured
            if [[ "${ARCH}" == "aarch64" ]]; then
              python3 scripts/impl/assert-aarch64-smp.py --run-dir "${latest}" --arch aarch64 --expected-online "${BOOT_SMP}"
            fi
          }

          if [[ "${ARCH}" == "x86_64" ]]; then
            make --no-print-directory ARCH=x86_64 TEST_TIMEOUT=180 test-x86-boot-smp
          else
            make --no-print-directory ARCH="${ARCH}" QEMU_SMP="${BOOT_SMP}" TEST_TIMEOUT=180 test-boot-smoke
          fi

          make --no-print-directory ARCH="${ARCH}" QEMU_SMP="${BOOT_SMP}" TEST_TIMEOUT="${GATE_TIMEOUT}" test-ipc-cap
          assert_structured_latest "${ARCH} ipc-cap gate"

          make --no-print-directory ARCH="${ARCH}" QEMU_SMP="${BOOT_SMP}" TEST_TIMEOUT="${GATE_TIMEOUT}" test-sched
          assert_structured_latest "${ARCH} sched gate"

          make --no-print-directory ARCH="${ARCH}" QEMU_SMP="${BOOT_SMP}" TEST_TIMEOUT="${GATE_TIMEOUT}" test-vfs-ipc
          assert_structured_latest "${ARCH} vfs/ipc gate"

          make --no-print-directory ARCH="${ARCH}" QEMU_SMP="${BOOT_SMP}" TEST_TIMEOUT=420 test-socket
          assert_structured_latest "${ARCH} socket gate"

      - name: Classify latest failure signatures
        if: always()
        run: |
          set -euo pipefail
          json_out="ci-failure-summary-${ARCH}.json"
          md_out="ci-failure-summary-${ARCH}.md"
          python3 scripts/impl/classify-run-failures.py \
            --runs-root build/runs \
            --latest-only \
            --json-out "${json_out}" \
            --markdown-out "${md_out}" || true
          if [[ -f "${md_out}" ]]; then
            cat "${md_out}" >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Capture latest isolated run
        id: latest_run
        if: always()
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          echo "path=${latest}" >> "${GITHUB_OUTPUT}"
          if [[ -n "${latest}" && -f "${latest}/result.json" ]]; then
            echo "Result file: ${latest}/result.json"
            cat "${latest}/result.json"
          fi

      - name: Upload quick-test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-${{ matrix.arch }}-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            ci-failure-summary-${{ matrix.arch }}.json
            ci-failure-summary-${{ matrix.arch }}.md
            ${{ steps.latest_run.outputs.path }}/manifest.json
            ${{ steps.latest_run.outputs.path }}/result.json
            ${{ steps.latest_run.outputs.path }}/${{ matrix.arch }}/logs/*.log
            ${{ steps.latest_run.outputs.path }}/${{ matrix.arch }}/*.log
            build/runs/*/manifest.json
            build/runs/*/result.json
            build/runs/*/${{ matrix.arch }}/logs/*.log
            build/runs/*/${{ matrix.arch }}/*.log
