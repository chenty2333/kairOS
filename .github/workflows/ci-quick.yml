name: ci-quick

on:
  push:
    tags:
      - quick-*
  workflow_dispatch:
    inputs:
      lane:
        description: "Quick lane selector (core|full|irq)"
        required: false
        default: "core"
      enable_bootdiag:
        description: "Enable riscv64 boot diagnostics artifact bundle"
        required: false
        default: "false"
      flake_sample_size:
        description: "Latest completed runs per workflow to inspect for flake report"
        required: false
        default: "20"
      flake_min_evaluated:
        description: "Minimum evaluated samples before enforcing flake thresholds"
        required: false
        default: "10"
      flake_max_fail_rate_percent:
        description: "Legacy fallback threshold (optional)"
        required: false
        default: ""
      flake_max_kernel_fail_rate_percent:
        description: "Fail when kernel-fail rate exceeds this percentage"
        required: false
        default: "10"
      flake_max_infra_fail_rate_percent:
        description: "Fail when infra-fail rate exceeds this percentage"
        required: false
        default: "20"

concurrency:
  group: ci-quick-${{ github.ref }}
  cancel-in-progress: true

jobs:
  riscv64-test:
    runs-on: ubuntu-24.04
    timeout-minutes: 150

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare CI environment
        uses: ./.github/actions/prepare-kairos-ci
        with:
          arch: riscv64

      - name: Capture riscv64 QEMU/UEFI diagnostics
        if: ${{ contains(github.ref_name, '-bootdiag-') || github.event.inputs.enable_bootdiag == 'true' }}
        run: |
          set -euo pipefail
          out_dir="ci-diagnostics/riscv64"
          mkdir -p "${out_dir}"
          {
            echo "date_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner_os=${RUNNER_OS:-unknown}"
            echo "runner_arch=${RUNNER_ARCH:-unknown}"
            echo "uefi_code_src=${UEFI_CODE_SRC:-unset}"
            echo "uefi_vars_src=${UEFI_VARS_SRC:-unset}"
          } > "${out_dir}/env.txt"
          qemu-system-riscv64 --version > "${out_dir}/qemu-version.txt"
          dpkg-query -W -f='${Package} ${Version}\n' \
            qemu-system-misc qemu-efi-riscv64 edk2-ovmf ovmf \
            > "${out_dir}/dpkg-qemu-edk2.txt" || true
          if [[ -n "${UEFI_CODE_SRC:-}" && -f "${UEFI_CODE_SRC}" ]]; then
            sha256sum "${UEFI_CODE_SRC}" > "${out_dir}/uefi-code.sha256"
            ls -l "${UEFI_CODE_SRC}" > "${out_dir}/uefi-code.ls.txt"
          fi
          if [[ -n "${UEFI_VARS_SRC:-}" && -f "${UEFI_VARS_SRC}" ]]; then
            sha256sum "${UEFI_VARS_SRC}" > "${out_dir}/uefi-vars.sha256"
            ls -l "${UEFI_VARS_SRC}" > "${out_dir}/uefi-vars.ls.txt"
          fi
          timeout 8s qemu-system-riscv64 \
            -machine virt,dumpdtb="${out_dir}/qemu-virt-ci.dtb" \
            -display none -serial none -nodefaults >/dev/null 2>&1 || true
          if [[ -f "${out_dir}/qemu-virt-ci.dtb" ]]; then
            sha256sum "${out_dir}/qemu-virt-ci.dtb" > "${out_dir}/qemu-virt-ci.dtb.sha256"
          fi

      - name: Build riscv64 minimal repro image bundle
        if: ${{ contains(github.ref_name, '-bootdiag-') || github.event.inputs.enable_bootdiag == 'true' }}
        run: |
          set -euo pipefail
          out_dir="ci-diagnostics/riscv64/repro"
          mkdir -p "${out_dir}"
          make --no-print-directory ARCH=riscv64 UEFI_BOOT_MODE=img QEMU_UEFI_BOOT_MODE=img uefi
          cp build/riscv64/boot.img "${out_dir}/boot.img"
          cp build/riscv64/kairos.elf "${out_dir}/kairos.elf"
          cp limine.cfg "${out_dir}/limine.cfg"
          {
            echo "ARCH=riscv64"
            echo "UEFI_BOOT_MODE=img"
            echo "QEMU_UEFI_BOOT_MODE=img"
          } > "${out_dir}/build-env.txt"
          sha256sum \
            "${out_dir}/boot.img" \
            "${out_dir}/kairos.elf" \
            "${out_dir}/limine.cfg" \
            > "${out_dir}/SHA256SUMS"

      - name: Run riscv64 syscall/trap gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: riscv64
          label: riscv64 syscall/trap gate
          make_vars: TEST_TIMEOUT=240
          make_target: test-syscall-trap

      - name: Run riscv64 vfs/ipc gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: riscv64
          label: riscv64 vfs/ipc gate
          make_vars: TEST_TIMEOUT=300
          make_target: test-vfs-ipc

      - name: Run riscv64 driver gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: riscv64
          label: riscv64 driver gate
          make_vars: TEST_TIMEOUT=300
          make_target: test-driver

      - name: Run riscv64 socket gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: riscv64
          label: riscv64 socket gate
          make_vars: TEST_TIMEOUT=360
          make_target: test-socket

      - name: Run riscv64 virtio IRQ matrix gate (AIA on/off)
        run: |
          set -euo pipefail
          make --no-print-directory ARCH=riscv64 TEST_TIMEOUT=420 test-device-virtio

      - name: Run riscv64 tcc smoke gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: riscv64
          label: riscv64 tcc smoke gate
          make_vars: TCC_SMOKE_ISOLATED=1 TCC_SMOKE_TIMEOUT=360
          make_target: test-tcc-smoke

      - name: Run riscv64 ABI baseline gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: riscv64
          label: riscv64 ABI gate
          make_vars: ABI_SMOKE_ISOLATED=1 ABI_SMOKE_TIMEOUT=300
          make_target: test-abi-smoke

      - name: Capture riscv64 ABI snapshot
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          if [[ -z "${latest}" ]]; then
            echo "No isolated run found after riscv64 ABI gate" >&2
            exit 2
          fi
          python3 scripts/impl/capture-abi-snapshot.py \
            --run-dir "${latest}" \
            --arch riscv64 \
            --json-out abi-snapshot-riscv64.json \
            --markdown-out abi-snapshot-riscv64.md
          python3 scripts/impl/compare-abi-snapshots.py \
            --baseline ci/abi-baseline/v1/riscv64.json \
            --current abi-snapshot-riscv64.json \
            --label-baseline baseline/riscv64 \
            --label-current current/riscv64 \
            --markdown-out abi-compare-riscv64.md
          cat abi-snapshot-riscv64.md >> "${GITHUB_STEP_SUMMARY}"
          cat abi-compare-riscv64.md >> "${GITHUB_STEP_SUMMARY}"

      - name: Capture latest isolated run
        id: latest_run
        if: always()
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          echo "path=${latest}" >> "${GITHUB_OUTPUT}"
          if [[ -n "${latest}" && -f "${latest}/result.json" ]]; then
            echo "Result file: ${latest}/result.json"
            cat "${latest}/result.json"
          fi

      - name: Upload quick-test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-riscv64-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            ${{ steps.latest_run.outputs.path }}/manifest.json
            ${{ steps.latest_run.outputs.path }}/result.json
            ${{ steps.latest_run.outputs.path }}/riscv64/logs/test.log
            ${{ steps.latest_run.outputs.path }}/riscv64/test.log
            ${{ steps.latest_run.outputs.path }}/riscv64/tcc-smoke.log
            ${{ steps.latest_run.outputs.path }}/riscv64/run.log
            build/runs/*/manifest.json
            build/runs/*/result.json
            build/runs/*/riscv64/logs/*.log
            build/runs/*/riscv64/*.log
            build/riscv64/test.log
            build/riscv64/test-device-virtio-*.log
            build/riscv64/tcc-smoke.log
            build/riscv64/run.log
            abi-snapshot-riscv64.json
            abi-snapshot-riscv64.md
            abi-compare-riscv64.md

      - name: Upload riscv64 boot diagnostics
        if: ${{ always() && (contains(github.ref_name, '-bootdiag-') || github.event.inputs.enable_bootdiag == 'true') }}
        uses: actions/upload-artifact@v4
        with:
          name: quick-riscv64-bootdiag-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            ci-diagnostics/riscv64/env.txt
            ci-diagnostics/riscv64/qemu-version.txt
            ci-diagnostics/riscv64/dpkg-qemu-edk2.txt
            ci-diagnostics/riscv64/uefi-code.sha256
            ci-diagnostics/riscv64/uefi-vars.sha256
            ci-diagnostics/riscv64/uefi-code.ls.txt
            ci-diagnostics/riscv64/uefi-vars.ls.txt
            ci-diagnostics/riscv64/qemu-virt-ci.dtb
            ci-diagnostics/riscv64/qemu-virt-ci.dtb.sha256
            ci-diagnostics/riscv64/repro/boot.img
            ci-diagnostics/riscv64/repro/kairos.elf
            ci-diagnostics/riscv64/repro/limine.cfg
            ci-diagnostics/riscv64/repro/build-env.txt
            ci-diagnostics/riscv64/repro/SHA256SUMS

  x86_64-gates:
    if: ${{ contains(github.ref_name, '-full-') || github.event.inputs.lane == 'full' }}
    runs-on: ubuntu-24.04
    timeout-minutes: 150

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare CI environment
        uses: ./.github/actions/prepare-kairos-ci
        with:
          arch: x86_64

      - name: Run x86_64 syscall/trap gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 syscall/trap gate
          make_vars: TEST_TIMEOUT=240
          make_target: test-syscall-trap

      - name: Run x86_64 vfs/ipc gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 vfs/ipc gate
          make_vars: TEST_TIMEOUT=300
          make_target: test-vfs-ipc

      - name: Run x86_64 driver gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 driver gate
          make_vars: QEMU_IOMMU=virtio TEST_TIMEOUT=300
          make_target: test-driver

      - name: Run x86_64 socket gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 socket gate
          make_vars: TEST_TIMEOUT=360
          make_target: test-socket

      - name: Run x86_64 tcc smoke gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 tcc smoke gate
          make_vars: TCC_SMOKE_ISOLATED=1 TCC_SMOKE_TIMEOUT=360
          make_target: test-tcc-smoke

      - name: Run x86_64 boot-chain gate (SMP=1/4)
        run: |
          set -euo pipefail
          make --no-print-directory ARCH=x86_64 TEST_TIMEOUT=180 test-x86-boot-smp

      - name: Run x86_64 ABI baseline gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 ABI gate
          make_vars: ABI_SMOKE_ISOLATED=1 ABI_SMOKE_TIMEOUT=300
          make_target: test-abi-smoke

      - name: Capture x86_64 ABI snapshot
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          if [[ -z "${latest}" ]]; then
            echo "No isolated run found after x86_64 ABI gate" >&2
            exit 2
          fi
          python3 scripts/impl/capture-abi-snapshot.py \
            --run-dir "${latest}" \
            --arch x86_64 \
            --json-out abi-snapshot-x86_64.json \
            --markdown-out abi-snapshot-x86_64.md
          python3 scripts/impl/compare-abi-snapshots.py \
            --baseline ci/abi-baseline/v1/x86_64.json \
            --current abi-snapshot-x86_64.json \
            --label-baseline baseline/x86_64 \
            --label-current current/x86_64 \
            --markdown-out abi-compare-x86_64.md
          cat abi-snapshot-x86_64.md >> "${GITHUB_STEP_SUMMARY}"
          cat abi-compare-x86_64.md >> "${GITHUB_STEP_SUMMARY}"

      - name: Capture latest isolated run
        id: latest_run_x86_64
        if: always()
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          echo "path=${latest}" >> "${GITHUB_OUTPUT}"
          if [[ -n "${latest}" && -f "${latest}/result.json" ]]; then
            echo "Result file: ${latest}/result.json"
            cat "${latest}/result.json"
          fi

      - name: Upload x86_64 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-x86_64-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            ${{ steps.latest_run_x86_64.outputs.path }}/manifest.json
            ${{ steps.latest_run_x86_64.outputs.path }}/result.json
            ${{ steps.latest_run_x86_64.outputs.path }}/x86_64/logs/test.log
            ${{ steps.latest_run_x86_64.outputs.path }}/x86_64/test.log
            ${{ steps.latest_run_x86_64.outputs.path }}/x86_64/tcc-smoke.log
            ${{ steps.latest_run_x86_64.outputs.path }}/x86_64/run.log
            build/runs/*/manifest.json
            build/runs/*/result.json
            build/runs/*/x86_64/logs/*.log
            build/runs/*/x86_64/*.log
            build/x86_64/test.log
            build/x86_64/test-x86-boot-smp-1.log
            build/x86_64/test-x86-boot-smp-4.log
            build/x86_64/tcc-smoke.log
            build/x86_64/run.log
            abi-snapshot-x86_64.json
            abi-snapshot-x86_64.md
            abi-compare-x86_64.md

  x86_64-irq-soak:
    if: ${{ contains(github.ref_name, '-irq-') || github.event.inputs.lane == 'irq' }}
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare CI environment
        uses: ./.github/actions/prepare-kairos-ci
        with:
          arch: x86_64

      - name: Run x86_64 irq soak gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: x86_64
          label: x86_64 irq soak gate
          make_vars: IRQ_SOAK_TEST_TIMEOUT=480
          make_target: test-irq-soak

      - name: Build aarch64 irq soak object sanity
        run: |
          set -euo pipefail
          make --no-print-directory ARCH=aarch64 CONFIG_VIRTIO_IOMMU=0 \
            EXTRA_CFLAGS="-DCONFIG_DRIVER_TEST_IRQ_SOAK_ONLY=1" \
            build/aarch64/kernel/core/tests/driver_tests.o

      - name: Capture latest isolated run
        id: latest_run_irq_soak
        if: always()
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          echo "path=${latest}" >> "${GITHUB_OUTPUT}"
          if [[ -n "${latest}" && -f "${latest}/result.json" ]]; then
            echo "Result file: ${latest}/result.json"
            cat "${latest}/result.json"
          fi

      - name: Upload irq soak artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: irq-soak-x86_64-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            ${{ steps.latest_run_irq_soak.outputs.path }}/manifest.json
            ${{ steps.latest_run_irq_soak.outputs.path }}/result.json
            ${{ steps.latest_run_irq_soak.outputs.path }}/x86_64/logs/test.log
            ${{ steps.latest_run_irq_soak.outputs.path }}/x86_64/test.log
            ${{ steps.latest_run_irq_soak.outputs.path }}/x86_64/run.log
            build/runs/*/manifest.json
            build/runs/*/result.json
            build/runs/*/x86_64/logs/*.log
            build/runs/*/x86_64/*.log
            build/x86_64/test.log

  aarch64-smoke:
    if: ${{ contains(github.ref_name, '-full-') || github.event.inputs.lane == 'full' }}
    runs-on: ubuntu-24.04
    timeout-minutes: 150

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare CI environment
        uses: ./.github/actions/prepare-kairos-ci
        with:
          arch: aarch64

      - name: Run aarch64 syscall/trap gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 syscall/trap gate
          make_vars: QEMU_SMP=2 TEST_TIMEOUT=240
          make_target: test-syscall-trap
          expected_online: "2"

      - name: Run aarch64 vfs/ipc gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 vfs/ipc gate
          make_vars: QEMU_SMP=2 TEST_TIMEOUT=300
          make_target: test-vfs-ipc
          expected_online: "2"

      - name: Run aarch64 driver gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 driver gate
          make_vars: QEMU_SMP=2 QEMU_IOMMU=virtio TEST_TIMEOUT=300
          make_target: test-driver
          expected_online: "2"

      - name: Run aarch64 socket gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 socket gate
          make_vars: QEMU_SMP=2 TEST_TIMEOUT=360
          make_target: test-socket
          expected_online: "2"

      - name: Run aarch64 tcc smoke gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 tcc smoke gate
          make_vars: QEMU_SMP=2 TCC_SMOKE_ISOLATED=1 TCC_SMOKE_TIMEOUT=360
          make_target: test-tcc-smoke
          expected_online: "2"

      - name: Run aarch64 smp4 syscall/trap gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 smp4 syscall/trap gate
          make_vars: QEMU_SMP=4 TEST_TIMEOUT=240
          make_target: test-syscall-trap
          expected_online: "4"

      - name: Run aarch64 smp4 vfs/ipc gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 smp4 vfs/ipc gate
          make_vars: QEMU_SMP=4 TEST_TIMEOUT=300
          make_target: test-vfs-ipc
          expected_online: "4"

      - name: Run aarch64 ABI baseline gate
        uses: ./.github/actions/run-gate-assert
        with:
          arch: aarch64
          label: aarch64 ABI gate
          make_vars: QEMU_SMP=2 ABI_SMOKE_ISOLATED=1 ABI_SMOKE_TIMEOUT=300
          make_target: test-abi-smoke
          expected_online: "2"

      - name: Capture aarch64 ABI snapshot
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          if [[ -z "${latest}" ]]; then
            echo "No isolated run found after aarch64 ABI gate" >&2
            exit 2
          fi
          python3 scripts/impl/capture-abi-snapshot.py \
            --run-dir "${latest}" \
            --arch aarch64 \
            --json-out abi-snapshot-aarch64.json \
            --markdown-out abi-snapshot-aarch64.md
          python3 scripts/impl/compare-abi-snapshots.py \
            --baseline ci/abi-baseline/v1/aarch64.json \
            --current abi-snapshot-aarch64.json \
            --label-baseline baseline/aarch64 \
            --label-current current/aarch64 \
            --markdown-out abi-compare-aarch64.md
          cat abi-snapshot-aarch64.md >> "${GITHUB_STEP_SUMMARY}"
          cat abi-compare-aarch64.md >> "${GITHUB_STEP_SUMMARY}"

      - name: Capture latest isolated run
        id: latest_run_aarch64
        if: always()
        run: |
          set -euo pipefail
          latest="$(ls -1dt build/runs/* 2>/dev/null | head -n 1 || true)"
          echo "path=${latest}" >> "${GITHUB_OUTPUT}"
          if [[ -n "${latest}" && -f "${latest}/result.json" ]]; then
            echo "Result file: ${latest}/result.json"
            cat "${latest}/result.json"
          fi

      - name: Upload aarch64 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-aarch64-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            ${{ steps.latest_run_aarch64.outputs.path }}/manifest.json
            ${{ steps.latest_run_aarch64.outputs.path }}/result.json
            ${{ steps.latest_run_aarch64.outputs.path }}/aarch64/logs/test.log
            ${{ steps.latest_run_aarch64.outputs.path }}/aarch64/test.log
            ${{ steps.latest_run_aarch64.outputs.path }}/aarch64/tcc-smoke.log
            ${{ steps.latest_run_aarch64.outputs.path }}/aarch64/run.log
            build/runs/*/manifest.json
            build/runs/*/result.json
            build/runs/*/aarch64/logs/*.log
            build/runs/*/aarch64/*.log
            build/aarch64/test.log
            build/aarch64/tcc-smoke.log
            build/aarch64/run.log
            abi-snapshot-aarch64.json
            abi-snapshot-aarch64.md
            abi-compare-aarch64.md

  flake-report:
    if: ${{ always() }}
    needs:
      - riscv64-test
      - x86_64-gates
      - x86_64-irq-soak
      - aarch64-smoke
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate rolling flake report (inline with ci-quick)
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        uses: ./.github/actions/run-flake-report
        with:
          sample_size: ${{ github.event.inputs.flake_sample_size || '20' }}
          min_evaluated: ${{ github.event.inputs.flake_min_evaluated || '10' }}
          max_fail_rate_percent: ${{ github.event.inputs.flake_max_fail_rate_percent || '' }}
          max_kernel_fail_rate_percent: ${{ github.event.inputs.flake_max_kernel_fail_rate_percent || '10' }}
          max_infra_fail_rate_percent: ${{ github.event.inputs.flake_max_infra_fail_rate_percent || '20' }}
          enforce: "true"

      - name: Upload flake report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-flake-report-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: error
          path: |
            ci-flake-report.json
            ci-flake-report.md
